{% extends 'base.html' %}

{% block title %}Chat with InnovateTech InfoBot{% endblock %}

{% block head_extra %}
<style>
    /* Chat specific styles */
    .chat-container {
        max-width: 900px;
        margin: 40px auto;
        background-color: var(--surface-color-dark);
        border-radius: 10px;
        box-shadow: 0 4px 15px var(--shadow-color-dark);
        border: 1px solid var(--border-color-dark);
        display: flex;
        flex-direction: column;
        height: 80vh; /* Occupy most of the viewport height */
        overflow: hidden; /* Hide scrollbar for the container itself */
    }

    .chat-header {
        background-color: var(--accent-color);
        color: white;
        padding: 15px 20px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        font-size: 1.8em;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        flex-shrink: 0; /* Prevent header from shrinking */
    }

    .chat-messages {
        flex-grow: 1; /* Takes up available space vertically within .chat-main */
        padding: 20px;
        overflow-y: auto; /* THIS IS THE KEY FOR SCROLLING */
        background-color: var(--surface-color-light); /* Slightly lighter background */
        border-bottom: 1px solid var(--border-color-dark);
        color: var(--text-color-light); /* Default text color */
        /* REMOVE these lines from .chat-messages: */
        /* display: flex; */
        /* flex-direction: column; */
        /* justify-content: flex-end; */
    }

    .message-bubble {
        margin-bottom: 15px;
        padding: 12px 18px;
        border-radius: 20px;
        max-width: 75%;
        word-wrap: break-word;
        line-height: 1.5;
        font-size: 1.05em;
        /* Keep align-self on individual messages for alignment */
    }

    .message-bubble.user {
        background-color: var(--primary-color); /* Blue-ish */
        color: white;
        margin-left: auto; /* Align to right */
        border-bottom-right-radius: 5px; /* Sharpen bottom-right for user */
        align-self: flex-end; /* Still needed if you want user messages right-aligned */
    }

    .message-bubble.bot {
        background-color: #555; /* Darker gray */
        color: white;
        margin-right: auto; /* Align to left */
        border-bottom-left-radius: 5px; /* Sharpen bottom-left for bot */
        align-self: flex-start; /* Still needed if you want bot messages left-aligned */
    }

    .message-timestamp {
        font-size: 0.75em;
        color: var(--text-color-faded);
        margin-top: -10px; /* Adjust as needed to be closer to bubble */
        margin-bottom: 15px; /* Match message-bubble margin */
        text-align: right; /* Default for user */
        align-self: flex-end; /* Match user bubble alignment */
    }

    .message-bubble.bot + .message-timestamp {
        text-align: left; /* Adjust for bot */
        align-self: flex-start; /* Match bot bubble alignment */
    }


    .chat-input-area {
        display: flex;
        padding: 20px;
        background-color: var(--surface-color-dark);
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
        border-top: 1px solid var(--border-color-dark);
        flex-shrink: 0; /* Prevent input area from shrinking */
    }

    .chat-input-area input[type="text"] {
        flex-grow: 1;
        padding: 12px 15px;
        border: 1px solid var(--border-color-dark);
        border-radius: 25px;
        background-color: var(--input-bg-dark);
        color: var(--text-color-light);
        font-size: 1em;
        margin-right: 10px;
        outline: none; /* Remove outline on focus */
        transition: border-color 0.3s ease;
    }

    .chat-input-area input[type="text"]:focus {
        border-color: var(--accent-color);
    }

    .chat-input-area button {
        background-color: var(--button-bg-dark);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 10px 20px;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .chat-input-area button:hover {
        background-color: var(--button-hover-dark);
    }

    .chat-sidebar {
        width: 250px;
        background-color: #2b2b2b;
        border-right: 1px solid #333;
        padding: 20px;
        overflow-y: auto; /* Make history scrollable */
        color: var(--text-color-light);
        display: flex;
        flex-direction: column;
        flex-shrink: 0; /* Prevents the sidebar from shrinking */
    }

    .chat-main {
        flex-grow: 1; /* Allows chat-main to take up all remaining space */
        display: flex;
        flex-direction: column; /* Stacks header, messages, input vertically */
        height: 100%; /* Ensure it fills parent's height */
    }

    .chat-app-container {
        display: flex;
        max-width: 1200px; /* Wider container for sidebar */
        margin: 40px auto;
        background-color: var(--surface-color-dark);
        border-radius: 10px;
        box-shadow: 0 4px 15px var(--shadow-color-dark);
        border: 1px solid var(--border-color-dark);
        height: 80vh; /* Fixed height for the entire app container */
        overflow: hidden; /* Hide any potential overall scrollbars */
    }

    .chat-sidebar h3 {
        color: var(--accent-color);
        margin-bottom: 20px;
        text-align: center;
        flex-shrink: 0; /* Prevent header from shrinking */
    }

    .chat-sidebar button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 15px;
        transition: background-color 0.3s ease;
        flex-shrink: 0; /* Prevent button from shrinking */
    }

    .chat-sidebar button:hover {
        background-color: var(--button-hover-dark);
    }

    .conversation-list {
        list-style: none;
        padding: 0;
        margin: 0;
        flex-grow: 1; /* Allow list to take up space vertically */
        overflow-y: auto; /* Make conversation list scrollable */
    }

    .conversation-list li {
        padding: 12px 10px;
        border-bottom: 1px solid #333;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: 0.95em;
    }

    .conversation-list li:last-child {
        border-bottom: none;
    }

    .conversation-list li:hover {
        background-color: #3a3a3a;
    }

    .conversation-list li.active {
        background-color: #444; /* Highlight active conversation */
        font-weight: bold;
        color: var(--accent-color);
    }

    .conversation-list li .preview {
        font-size: 0.8em;
        color: var(--text-color-faded);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-app-container">
    <div class="chat-sidebar">
        <h3>Conversations</h3>
        <button id="newChatBtn">Start New Chat</button>
        <ul id="conversationList" class="conversation-list">
            <p style="text-align: center;">Loading conversations...</p>
        </ul>
    </div>
    <div class="chat-main">
        <div class="chat-header">Spryle NavBot</div>
        <div class="chat-messages" id="chatMessages">
            <p style="text-align: center; color: var(--text-color-faded);">Select a conversation or start a new one!</p>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type your message..." autocomplete="off">
            <button id="sendMessageBtn">Send</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatInput = document.getElementById('chatInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const chatMessages = document.getElementById('chatMessages');
    const newChatBtn = document.getElementById('newChatBtn');
    const conversationList = document.getElementById('conversationList');

    let currentConversationId = null;

    // --- Helper for showing global messages (if you have one in base.html) ---
    function showGlobalMessage(message, type = 'info', redirectUrl = null) {
        const messageContainer = document.getElementById('globalMessageContainer'); // Assuming you have this in base.html
        if (messageContainer) {
            messageContainer.textContent = message;
            messageContainer.className = `global-message ${type}`; // Add styling for success/error
            messageContainer.style.display = 'block';
            setTimeout(() => {
                messageContainer.style.display = 'none';
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                }
            }, 3000); // Hide after 3 seconds
        } else {
            alert(message); // Fallback to alert if no global message container
            if (redirectUrl) {
                window.location.href = redirectUrl;
            }
        }
    }

    // --- Function to add a message to the chat display ---
    function addMessageToChat(message) {
        const messageBubble = document.createElement('div');
        messageBubble.className = `message-bubble ${message.sender}`;
        messageBubble.textContent = message.content;

        const timestampDiv = document.createElement('div');
        timestampDiv.className = `message-timestamp ${message.sender}`;
        const date = new Date(message.timestamp);
        timestampDiv.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // Append to the chatMessages container
        chatMessages.appendChild(messageBubble);
        chatMessages.appendChild(timestampDiv);
        
        // Auto-scroll to bottom after adding new messages
        chatMessages.scrollTop = chatMessages.scrollHeight; 
    }

    // --- Function to load and display messages for a conversation ---
    async function loadConversation(conversationId) {
        currentConversationId = conversationId;
        chatMessages.innerHTML = '<p style="text-align: center; color: var(--text-color-faded);">Loading messages...</p>';
        document.querySelectorAll('.conversation-list li').forEach(item => {
            item.classList.remove('active');
            if (parseInt(item.dataset.conversationId) === conversationId) {
                item.classList.add('active');
            }
        });

        try {
            const response = await fetch(`/api/chat/history/${conversationId}`);
            if (response.ok) {
                const conversationData = await response.json();
                chatMessages.innerHTML = ''; // Clear loading message
                if (conversationData.messages && conversationData.messages.length > 0) {
                    conversationData.messages.forEach(msg => addMessageToChat(msg));
                } else {
                    chatMessages.innerHTML = '<p style="text-align: center; color: var(--text-color-faded);">Start typing to begin this conversation!</p>';
                }
            } else {
                chatMessages.innerHTML = '<p class="error-text">Failed to load conversation history.</p>';
                showGlobalMessage('Failed to load conversation history.', 'error');
            }
        } catch (error) {
            console.error('Error loading conversation history:', error);
            chatMessages.innerHTML = '<p class="error-text">Network error loading conversation history.</p>';
            showGlobalMessage('Network error loading conversation history.', 'error');
        }
    }

    // --- Function to fetch and display all conversations ---
    async function fetchAllConversations() {
        conversationList.innerHTML = '<p style="text-align: center;">Loading conversations...</p>';
        try {
            const response = await fetch('/api/chat/conversations');
            if (response.ok) {
                const conversations = await response.json();
                conversationList.innerHTML = ''; // Clear loading message
                if (conversations.length > 0) {
                    conversations.forEach(conv => {
                        const listItem = document.createElement('li');
                        listItem.dataset.conversationId = conv.id;
                        listItem.innerHTML = `
                            <span>Chat ${conv.id} (${new Date(conv.started_at).toLocaleDateString()})</span>
                            <div class="preview">${conv.first_message_preview || 'No messages yet...'}</div>
                        `;
                        listItem.addEventListener('click', () => loadConversation(conv.id));
                        conversationList.appendChild(listItem);
                    });

                    // Auto-load the most recent conversation if none is selected
                    const lastActiveConvId = sessionStorage.getItem('lastActiveConversationId');
                    if (lastActiveConvId && conversations.some(conv => conv.id === parseInt(lastActiveConvId))) {
                        loadConversation(parseInt(lastActiveConvId));
                    } else if (conversations.length > 0) {
                        loadConversation(conversations[0].id);
                    }
                } else {
                    conversationList.innerHTML = '<p style="text-align: center;">No conversations yet. Start a new one!</p>';
                }
            } else {
                conversationList.innerHTML = '<p class="error-text">Error fetching conversations.</p>';
                showGlobalMessage('Error fetching conversations.', 'error');
            }
        } catch (error) {
            console.error('Error fetching conversations:', error);
            conversationList.innerHTML = '<p class="error-text">Network error fetching conversations.</p>';
            showGlobalMessage('Network error fetching conversations.', 'error');
        }
    }

    // --- Function to send a new message ---
    async function sendMessage() {
        const messageText = chatInput.value.trim();
        if (!messageText) return;

        chatInput.value = ''; // Clear input field
        sendMessageBtn.disabled = true; // Disable button

        // Display user message immediately
        addMessageToChat({ sender: 'user', content: messageText, timestamp: new Date().toISOString() });

        try {
            const response = await fetch('/api/chat/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: messageText, conversation_id: currentConversationId })
            });

            const result = await response.json();

            if (response.ok) {
                if (!currentConversationId) {
                    // If a new conversation was implicitly started by the backend
                    currentConversationId = result.user_message.conversation_id;
                    sessionStorage.setItem('lastActiveConversationId', currentConversationId); // Save for next load
                    await fetchAllConversations(); // Refresh conversation list (to highlight new active chat)
                }
                // Display bot message
                addMessageToChat(result.bot_message);
                if (currentConversationId) {
                    const currentConvListItem = document.querySelector(`.conversation-list li[data-conversation-id="${currentConversationId}"]`);
                    if (currentConvListItem) {
                        const previewDiv = currentConvListItem.querySelector('.preview');
                        if (previewDiv) {
                            previewDiv.textContent = messageText.substring(0, 50) + (messageText.length > 50 ? '...' : '');
                        }
                    }
                }
            } else {
                showGlobalMessage(result.message || 'Failed to send message.', 'error');
                // If the bot message was sent back in the error response, display it
                if (result.bot_message) {
                    addMessageToChat(result.bot_message);
                }
            }
        } catch (error) {
            console.error('Error sending message:', error);
            showGlobalMessage('Network error sending message. Please try again.', 'error');
            addMessageToChat({ sender: 'bot', content: "I'm sorry, I couldn't connect. Please check your internet connection.", timestamp: new Date().toISOString() });
        } finally {
            sendMessageBtn.disabled = false; // Re-enable button
            chatInput.focus(); // Focus input for next message
        }
    }

    // --- Event Listeners ---
    sendMessageBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    newChatBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/api/chat/start_new', { method: 'POST' });
            const result = await response.json();
            if (response.ok) {
                showGlobalMessage(result.message, 'success');
                currentConversationId = result.conversation_id;
                sessionStorage.setItem('lastActiveConversationId', currentConversationId); // Save for next load
                await fetchAllConversations(); // Refresh list to show new chat
                loadConversation(currentConversationId); // Load the empty new chat
            } else {
                showGlobalMessage(result.message || 'Failed to start new chat.', 'error');
            }
        } catch (error) {
            console.error('Error starting new chat:', error);
            showGlobalMessage('Network error starting new chat.', 'error');
        }
    });


    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', fetchAllConversations);

</script>
{% endblock %}