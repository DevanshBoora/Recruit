{% extends "base.html" %}

{% block title %}Feedback Dashboard - Job Application System{% endblock %}

{% block content %}
<h1>Interview Feedback Dashboard</h1>

<div class="card">
    <h3>Interview Feedback Summary</h3>
    {% if feedback %}
        <table>
            <thead>
                <tr>
                    <th>Candidate Name</th>
                    <th>Email</th>
                    <th>Interview Date</th>
                    <th>Decision</th>
                    <th>Communication</th>
                    <th>Technical</th>
                    <th>Problem Solving</th>
                    <th>Comments</th>
                    <th>Email Status</th>
                </tr>
            </thead>
            <tbody>
                {% for row in feedback %}
                <tr>
                    <td>{{ row.applicant_name }}</td>
                    <td>{{ row.applicant_email }}</td>
                    <td>{{ row.interview_date.strftime('%Y-%m-%d %H:%M') if row.interview_date else 'N/A' }}</td>
                    <td>
                        {% if row.decision == 'Accepted' %}
                            <span style="color: #28a745; font-weight: bold;">✓ Accepted</span>
                        {% else %}
                            <span style="color: #dc3545; font-weight: bold;">✗ Rejected</span>
                        {% endif %}
                    </td>
                    <td>{{ row.communication_score }}/10</td>
                    <td>{{ row.technical_score }}/10</td>
                    <td>{{ row.problem_solving_score }}/10</td>
                    <td>
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                             title="{{ row.comments }}">
                            {{ row.comments[:50] }}{% if row.comments|length > 50 %}...{% endif %}
                        </div>
                    </td>
                    <td>
                        {% if row.decision == 'Rejected' %}
                            {% if row.rejection_email_sent %}
                                <span style="color: #28a745;">✓ Email Sent</span>
                            {% else %}
                                <span style="color: #dc3545;">⚠ Pending</span>
                            {% endif %}
                        {% else %}
                            <span style="color: #6c757d;">N/A</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div style="margin-top: 20px;">
            <h4>Summary Statistics</h4>
            {% set accepted_count = feedback | selectattr('decision', 'equalto', 'Accepted') | list | length %}
            {% set rejected_count = feedback | selectattr('decision', 'equalto', 'Rejected') | list | length %}
            {% set total_count = feedback | length %}
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h5 style="margin: 0; color: #495057;">Total Interviews</h5>
                    <p style="font-size: 24px; font-weight: bold; margin: 5px 0; color: #007bff;">{{ total_count }}</p>
                </div>
                
                <div style="background-color: #d4edda; padding: 15px; border-radius: 5px; text-align: center;">
                    <h5 style="margin: 0; color: #155724;">Accepted</h5>
                    <p style="font-size: 24px; font-weight: bold; margin: 5px 0; color: #28a745;">{{ accepted_count }}</p>
                </div>
                
                <div style="background-color: #f8d7da; padding: 15px; border-radius: 5px; text-align: center;">
                    <h5 style="margin: 0; color: #721c24;">Rejected</h5>
                    <p style="font-size: 24px; font-weight: bold; margin: 5px 0; color: #dc3545;">{{ rejected_count }}</p>
                </div>
                
                <div style="background-color: #e2e3e5; padding: 15px; border-radius: 5px; text-align: center;">
                    <h5 style="margin: 0; color: #383d41;">Acceptance Rate</h5>
                    <p style="font-size: 24px; font-weight: bold; margin: 5px 0; color: #6c757d;">
                        {% if total_count > 0 %}
                            {{ "%.1f"|format((accepted_count / total_count) * 100) }}%
                        {% else %}
                            0%
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        
        {% if feedback %}
            {% set avg_comm = (feedback | sum(attribute='communication_score')) / (feedback | length) %}
            {% set avg_tech = (feedback | sum(attribute='technical_score')) / (feedback | length) %}
            {% set avg_prob = (feedback | sum(attribute='problem_solving_score')) / (feedback | length) %}
            
            <div style="margin-top: 20px;">
                <h4>Average Scores</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; text-align: center;">
                        <h5 style="margin: 0; color: #856404;">Communication</h5>
                        <p style="font-size: 24px; font-weight: bold; margin: 5px 0; color: #ffc107;">{{ "%.1f"|format(avg_comm) }}/10</p>
                    </div>
                    
                    <div style="background-color: #d1ecf1; padding: 15px; border-radius: 5px; text-align: center;">
                        <h5 style="margin: 0; color: #0c5460;">Technical</h5>
                        <p style="font-size: 24px; font-weight: bold; margin: 5px 0; color: #17a2b8;">{{ "%.1f"|format(avg_tech) }}/10</p>
                    </div>
                    
                    <div style="background-color: #e7e7ff; padding: 15px; border-radius: 5px; text-align: center;">
                        <h5 style="margin: 0; color: #4c4c9d;">Problem Solving</h5>
                        <p style="font-size: 24px; font-weight: bold; margin: 5px 0; color: #6f42c1;">{{ "%.1f"|format(avg_prob) }}/10</p>
                    </div>
                </div>
            </div>
        {% endif %}
        
    {% else %}
        <div class="alert info">
            <p>No interview feedback available yet.</p>
        </div>
    {% endif %}
</div>
{% endblock %}